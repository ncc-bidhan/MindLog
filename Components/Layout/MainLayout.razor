@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@inject ThemeService ThemeService

<MudThemeProvider IsDarkMode="@ThemeService.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<CascadingValue Value="@ThemeService.IsDarkMode" Name="IsDarkTheme">
    @if (ShouldShowSidebar)
    {
        <div class="page @(ThemeService.IsDarkMode ? "dark-theme" : "light-theme")">
            <div class="sidebar">
                <NavMenu />
            </div>

            <main>
                <article class="content px-4">
                    @Body
                </article>
            </main>
        </div>
    }
    else
    {
        <div class="page-no-sidebar @(ThemeService.IsDarkMode ? "dark-theme" : "light-theme")">
            @Body
        </div>
    }
</CascadingValue>

<ToastNotification Show="@showToast" Type="@toastType" Title="@toastTitle" Message="@toastMessage" />

@code {
    private bool ShouldShowSidebar = true;

    private bool showToast = false;
    private string toastType = "";
    private string toastTitle = "";
    private string toastMessage = "";

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        ToastService.OnShow += HandleToast;
        ThemeService.OnThemeChanged += HandleThemeChanged;
        UpdateSidebarVisibility();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateSidebarVisibility();
        StateHasChanged();
    }

    private void HandleThemeChanged(bool isDark)
    {
        StateHasChanged();
    }

    private void UpdateSidebarVisibility()
    {
        var currentPath = NavigationManager.ToAbsoluteUri(NavigationManager.Uri).AbsolutePath;
        ShouldShowSidebar = currentPath != "/login" && currentPath != "/register";
    }

    private void HandleToast(bool show, string type, string title, string message)
    {
        showToast = show;
        toastType = type;
        toastTitle = title;
        toastMessage = message;
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        ToastService.OnShow -= HandleToast;
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }
}