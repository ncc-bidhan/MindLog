@page "/settings"
@inject AuthStateService AuthStateService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService
@inject IAuthService AuthService
@inject ToastService ToastService

@implements IDisposable

@if (!AuthStateService.IsAuthenticated)
{
    NavigationManager.NavigateTo("/login");
}
else
{
    <div class="settings-container">
        <h1 class="settings-title">Settings</h1>
        
        <div class="settings-sections">
            <!-- Appearance Section -->
            <div class="settings-section">
                <h2 class="section-title">Appearance</h2>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3 class="setting-label">Theme</h3>
                        <p class="setting-description">Choose your preferred theme for the application</p>
                    </div>
                    <div class="setting-control">
                        <div class="theme-toggle">
                            <button class="theme-option @(ThemeService.IsDarkMode ? "" : "active")" 
                                    @onclick="() => SetTheme(false)">
                                <span class="theme-icon">‚òÄÔ∏è</span>
                                <span class="theme-label">Light</span>
                            </button>
                            <button class="theme-option @(ThemeService.IsDarkMode ? "active" : "")" 
                                    @onclick="() => SetTheme(true)">
                                <span class="theme-icon">üåô</span>
                                <span class="theme-label">Dark</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div class="settings-section">
                <h2 class="section-title">Account</h2>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3 class="setting-label">User Information</h3>
                        <p class="setting-description">Manage your account details</p>
                    </div>
                    <div class="setting-control">
                        <div class="user-info">
                            <p class="user-email">@AuthStateService.CurrentUser?.Username</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div class="settings-section">
                <h2 class="section-title">Security</h2>
                
                <div class="setting-item">
                    <div class="setting-info w-100">
                        <h3 class="setting-label">Change PIN</h3>
                        <div class="password-form">
                            <div class="form-group">
                                <label>Current PIN</label>
                                <input type="password" @bind="currentPin" class="form-input" placeholder="Enter current PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric" />
                            </div>
                            <div class="form-group">
                                <label>New PIN</label>
                                <input type="password" @bind="newPin" class="form-input" placeholder="Enter new PIN (4-6 digits)" maxlength="6" pattern="[0-9]*" inputmode="numeric" />
                            </div>
                            <div class="form-group">
                                <label>Confirm New PIN</label>
                                <input type="password" @bind="confirmPin" class="form-input" placeholder="Confirm new PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric" />
                            </div>
                            <button class="change-password-btn" @onclick="ChangePin" disabled="@isChangingPin">
                                @(isChangingPin ? "Updating..." : "Update PIN")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string currentPin = "";
    private string newPin = "";
    private string confirmPin = "";
    private bool isChangingPin = false;

    protected override async Task OnInitializedAsync()
    {
        if (AuthStateService.IsAuthenticated)
        {
            ThemeService.OnThemeChanged += HandleThemeChanged;
            await ThemeService.InitializeAsync();
        }
    }

    private void HandleThemeChanged(bool isDark)
    {
        StateHasChanged();
    }

    private async Task SetTheme(bool isDark)
    {
        await ThemeService.SetThemeAsync(isDark);
    }

    private async Task ChangePin()
    {
        if (string.IsNullOrWhiteSpace(currentPin) || string.IsNullOrWhiteSpace(newPin) || string.IsNullOrWhiteSpace(confirmPin))
        {
            ToastService.ShowError("Validation Error", "All PIN fields are required.");
            return;
        }

        if (newPin != confirmPin)
        {
            ToastService.ShowError("Validation Error", "New PINs do not match.");
            return;
        }

        if (AuthStateService.CurrentUser == null) return;

        isChangingPin = true;
        try
        {
            await AuthService.ChangePinAsync(AuthStateService.CurrentUser.Id, currentPin, newPin);
            ToastService.ShowSuccess("Success", "PIN updated successfully.");
            
            // Clear fields
            currentPin = "";
            newPin = "";
            confirmPin = "";
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            isChangingPin = false;
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }
}