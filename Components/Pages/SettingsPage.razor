@page "/settings"
@inject AuthStateService AuthStateService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService
@inject IAuthService AuthService
@inject ToastService ToastService

@implements IDisposable

@if (!AuthStateService.IsAuthenticated)
{
    NavigationManager.NavigateTo("/login");
}
else
{
    <div class="settings-container">
        <h1 class="settings-title">Settings</h1>
        
        <div class="settings-sections">
            <!-- Appearance Section -->
            <div class="settings-section">
                <h2 class="section-title">Appearance</h2>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3 class="setting-label">Theme</h3>
                        <p class="setting-description">Choose your preferred theme for the application</p>
                    </div>
                    <div class="setting-control">
                        <div class="theme-toggle">
                            <button class="theme-option @(ThemeService.IsDarkMode ? "" : "active")" 
                                    @onclick="() => SetTheme(false)">
                                <span class="theme-icon">‚òÄÔ∏è</span>
                                <span class="theme-label">Light</span>
                            </button>
                            <button class="theme-option @(ThemeService.IsDarkMode ? "active" : "")" 
                                    @onclick="() => SetTheme(true)">
                                <span class="theme-icon">üåô</span>
                                <span class="theme-label">Dark</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div class="settings-section">
                <h2 class="section-title">Account</h2>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3 class="setting-label">User Information</h3>
                        <p class="setting-description">Manage your account details</p>
                    </div>
                    <div class="setting-control">
                        <div class="user-info">
                            <p class="user-email">@AuthStateService.CurrentUser?.Username</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div class="settings-section">
                <h2 class="section-title">Security</h2>
                
                <div class="setting-item">
                    <div class="setting-info w-100">
                        <h3 class="setting-label">Change Password</h3>
                        <div class="password-form">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" @bind="currentPassword" class="form-input" placeholder="Enter current password" />
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" @bind="newPassword" class="form-input" placeholder="Enter new password" />
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" @bind="confirmPassword" class="form-input" placeholder="Confirm new password" />
                            </div>
                            <button class="change-password-btn" @onclick="ChangePassword" disabled="@isChangingPassword">
                                @(isChangingPassword ? "Updating..." : "Update Password")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private bool isChangingPassword = false;

    protected override async Task OnInitializedAsync()
    {
        if (AuthStateService.IsAuthenticated)
        {
            ThemeService.OnThemeChanged += HandleThemeChanged;
            await ThemeService.InitializeAsync();
        }
    }

    private void HandleThemeChanged(bool isDark)
    {
        StateHasChanged();
    }

    private async Task SetTheme(bool isDark)
    {
        await ThemeService.SetThemeAsync(isDark);
    }

    private async Task ChangePassword()
    {
        if (string.IsNullOrWhiteSpace(currentPassword) || string.IsNullOrWhiteSpace(newPassword) || string.IsNullOrWhiteSpace(confirmPassword))
        {
            ToastService.ShowError("Validation Error", "All password fields are required.");
            return;
        }

        if (newPassword != confirmPassword)
        {
            ToastService.ShowError("Validation Error", "New passwords do not match.");
            return;
        }

        if (AuthStateService.CurrentUser == null) return;

        isChangingPassword = true;
        try
        {
            await AuthService.ChangePasswordAsync(AuthStateService.CurrentUser.Id, currentPassword, newPassword);
            ToastService.ShowSuccess("Success", "Password updated successfully.");
            
            // Clear fields
            currentPassword = "";
            newPassword = "";
            confirmPassword = "";
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", ex.Message);
        }
        finally
        {
            isChangingPassword = false;
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }
}