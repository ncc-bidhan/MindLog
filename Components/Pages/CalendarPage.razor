@page "/calendar"
@inject AuthStateService AuthStateService
@inject NavigationManager NavigationManager

@code {
    protected override void OnInitialized()
    {
        if (!AuthStateService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
    }

    protected override void OnParametersSet()
    {
        if (!AuthStateService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
        }
    }
}

@if (AuthStateService.IsAuthenticated)
{
    <div class="calendar-page">
        <div class="page-header mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Journal Calendar</h1>
            <p class="text-gray-600">Navigate through your journal entries with an interactive calendar view</p>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section mb-6 bg-white rounded-lg shadow p-4">
            <div class="flex flex-wrap gap-4 items-end">
                <!-- Search Input -->
                <div class="flex-1 min-w-[200px]">
                    <label for="calendar-search" class="block text-sm font-medium text-gray-700 mb-1">Search Entries</label>
                    <div class="relative">
                        <input type="text" 
                               id="calendar-search"
                               @bind="searchTerm"
                               @oninput="HandleSearchInput"
                               placeholder="Search titles, content, or tags..."
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                </div>

                <!-- Mood Filter -->
                <div class="min-w-[150px]">
                    <label for="mood-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Mood</label>
                    <select id="mood-filter" 
                            @bind="selectedMoodId" 
                            @bind:after="HandleMoodChange"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="0">All Moods</option>
                        @foreach (var mood in availableMoods)
                        {
                            <option value="@mood.Id">@mood.Icon @mood.Name</option>
                        }
                    </select>
                </div>

                <!-- Date Range -->
                <div class="min-w-[120px]">
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" 
                           id="start-date"
                           @bind="startDate"
                           @bind:after="HandleDateChange"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>

                <div class="min-w-[120px]">
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" 
                           id="end-date"
                           @bind="endDate"
                           @bind:after="HandleDateChange"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>

                <!-- Clear Filters -->
                <button @onclick="ClearFilters" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Calendar Component -->
        <CalendarView SearchTerm="@searchTerm" 
                     SelectedMoodId="@selectedMoodId" 
                     StartDate="@startDate?.ToString("yyyy-MM-dd")" 
                     EndDate="@endDate?.ToString("yyyy-MM-dd")" />
    </div>
}

@code {
    // Search and filter state
    private string searchTerm = string.Empty;
    private int selectedMoodId = 0;
    private DateTime? startDate;
    private DateTime? endDate;
    private List<Mood> availableMoods = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadAvailableMoods();
    }

    private async Task LoadAvailableMoods()
    {
        try
        {
            availableMoods = MoodDefinitions.PredefinedMoods
                .Where(m => m.IsActive)
                .OrderBy(m => m.Category)
                .ThenBy(m => m.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading moods: {ex.Message}");
        }
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        await Task.Delay(300); // Debounce search
        StateHasChanged();
    }

    private async Task HandleDateChange()
    {
        // Trigger calendar refresh when date filters change
        StateHasChanged();
    }

    private async Task HandleMoodChange()
    {
        // Trigger calendar refresh when mood filter changes
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedMoodId = 0;
        startDate = null;
        endDate = null;
        StateHasChanged();
    }
}