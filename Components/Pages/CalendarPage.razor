@page "/calendar"
@implements IDisposable
@inject AuthStateService AuthStateService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService

@if (AuthStateService.IsAuthenticated)
{
    <div class="calendar-page">
        <div class="page-header">
            <h1>Journal Calendar</h1>
            <p>Navigate through your journal entries with an interactive calendar view</p>
        </div>


        <!-- Calendar Component -->
        <CalendarView SearchTerm="@searchTerm" 
                     SelectedMoodId="@selectedMoodId" 
                     StartDate="@startDate?.ToString("yyyy-MM-dd")" 
                     EndDate="@endDate?.ToString("yyyy-MM-dd")" />
    </div>
}

@code {
    // Search and filter state
    private string searchTerm = string.Empty;
    private int selectedMoodId = 0;
    private DateTime? startDate;
    private DateTime? endDate;
    private List<Mood> availableMoods = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        if (!AuthStateService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        ThemeService.OnThemeChanged += HandleThemeChanged;
        await LoadAvailableMoods();
    }

    protected override void OnParametersSet()
    {
        if (!AuthStateService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }

    private void HandleThemeChanged(bool isDark)
    {
        StateHasChanged();
    }

    private async Task LoadAvailableMoods()
    {
        try
        {
            availableMoods = MoodDefinitions.PredefinedMoods
                .Where(m => m.IsActive)
                .OrderBy(m => m.Category)
                .ThenBy(m => m.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading moods: {ex.Message}");
        }
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        await Task.Delay(300);
        StateHasChanged();
    }

    private async Task HandleDateChange()
    {
        StateHasChanged();
    }

    private async Task HandleMoodChange()
    {
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedMoodId = 0;
        startDate = null;
        endDate = null;
        StateHasChanged();
    }
}
