@using MindLog.Models
@inject NavigationManager NavigationManager
@inject JournalEntryService JournalEntryService
@inject StreakService StreakService
@inject AuthStateService AuthStateService
@inject ToastService ToastService
@inject IJSRuntime JS

@if (loading)
{
    <div class="loading-view">
        <div class="loading-spinner"></div>
        <p class="text-secondary">Loading entry...</p>
    </div>
}
else if (entry == null)
{
    <div class="error-view">
        <div class="error-icon">üìù</div>
        <h3 class="error-title">Entry not found</h3>
        <p class="error-text">The journal entry you're looking for doesn't exist.</p>
        <button class="btn-primary" @onclick="GoBack">Back to Journal</button>
    </div>
}
else
{
        <div class="entry-card">
            <div class="entry-header">
                <div class="entry-actions">
                    <button class="back-link" @onclick="GoBack">
                        ‚Üê Back to Journal
                    </button>
                    <div class="action-buttons">
                        <button class="edit-btn" @onclick="EditEntry">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="delete-btn" @onclick="DeleteEntry">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h1 class="entry-title">@entry.Title</h1>
                    <div class="entry-meta">
                        <div class="entry-date">
                            <span>üìÖ @entry.EntryDate.ToString("dddd, MMMM dd, yyyy")</span>
                        </div>
                    </div>
                    
                    @if (entryMoods != null && entryMoods.Any())
                    {
                        <div class="mood-chips">
                            @foreach (var entryMood in entryMoods)
                            {
                                <span class="mood-chip @GetMoodCategoryClass(entryMood.Mood.Category)">
                                    <span class="text-base">@entryMood.Mood.Icon</span>
                                    <span>@entryMood.Mood.Name</span>
                                    @if (entryMood.IsPrimary)
                                    {
                                        <span class="primary-badge">Primary</span>
                                    }
                                </span>
                            }
                        </div>
                    }
                    
                    <div class="entry-timestamps">
                        <span>Created @entry.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                        <span>Updated @entry.UpdatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                    </div>
                </div>
            </div>

            <div class="entry-content-area">
                @if (!string.IsNullOrEmpty(entry.Content))
                {
                    <div class="prose">
                        @((MarkupString)RenderedContent)
                    </div>
                }
                else
                {
                    <div class="empty-content">
                        <p>No content available for this entry.</p>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(entry.Tags))
            {
                <div class="entry-tags-section">
                    <h3 class="tags-title">Tags</h3>
                    <div class="tag-list">
                        @foreach (var tag in GetTags(entry.Tags))
                        {
                            <span class="tag-item">
                                @tag
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private JournalEntry? entry;
    private List<JournalEntryMood>? entryMoods;
    private bool loading = true;
    private string RenderedContent = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadEntry();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadEntry();
    }

    private async Task LoadEntry()
    {
        if (AuthStateService.CurrentUser?.Id == null)
        {
            loading = false;
            return;
        }

        loading = true;
        try
        {
            entry = await JournalEntryService.GetEntryByIdAsync(Id, AuthStateService.CurrentUser.Id);
            if (entry != null)
            {
                RenderedContent = await ConvertMarkdownToHtml(entry.Content);
                entryMoods = await JournalEntryService.GetEntryMoodsAsync(Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entry: {ex.Message}");
            ToastService.ShowError("Error", "Failed to load journal entry. Please try again.");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task<string> ConvertMarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return "";

        try
        {
            return await JS.InvokeAsync<string>("markdownToHtml", markdown);
        }
        catch
        {
            return ConvertSimpleMarkdown(markdown);
        }
    }

    private string ConvertSimpleMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return "";

        var html = markdown;
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"### (.*)", "<h3>$1</h3>");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"## (.*)", "<h2>$1</h2>");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"# (.*)", "<h1>$1</h1>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"\*(.*?)\*", "<em>$1</em>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"`([^`]+)`", "<code>$1</code>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^- (.*)", "<li>$1</li>");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"(<li>.*</li>\s*)+", "<ul>$1</ul>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^\d+\. (.*)", "<li>$1</li>");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"(<li>.*</li>\s*)+", "<ol>$1</ol>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"> (.*)", "<blockquote>$1</blockquote>");
        
        html = System.Text.RegularExpressions.Regex.Replace(html, @"\[(.*?)\]\((.*?)\)", "<a href=\"$2\" target=\"_blank\">$1</a>");
        
        html = html.Replace("\n", "<br>");
        
        return html;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/journal");
    }

    private void EditEntry()
    {
        NavigationManager.NavigateTo($"/journal/edit/{Id}");
    }

    private async Task DeleteEntry()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry? This action cannot be undone."))
        {
            if (AuthStateService.CurrentUser?.Id != null)
            {
                try
                {
                    await JournalEntryService.DeleteEntryAsync(Id, AuthStateService.CurrentUser.Id);
                    
                    // Update streak after deletion
                    await StreakService.UpdateStreakAfterDeletionAsync(AuthStateService.CurrentUser.Id);
                    
                    ToastService.ShowSuccess("Success", ToastMessages.EntryDeleted);
                    NavigationManager.NavigateTo("/journal");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deleting entry: {ex.Message}");
                    ToastService.ShowError("Error", "Failed to delete entry. Please try again.");
                }
            }
        }
    }

    private string GetMoodEmoji(string mood)
    {
        return mood.ToLower() switch
        {
            "happy" => "üòä",
            "sad" => "üò¢",
            "excited" => "üéâ",
            "anxious" => "üò∞",
            "grateful" => "üôè",
            "frustrated" => "üò§",
            "peaceful" => "üòå",
            _ => "üòê"
        };
    }

    private List<string> GetTags(string tagsString)
    {
        if (string.IsNullOrEmpty(tagsString))
            return new List<string>();

        return tagsString.Split(new[] { ',', ';', ' ' }, StringSplitOptions.RemoveEmptyEntries)
                       .Select(tag => tag.Trim())
                       .Where(tag => !string.IsNullOrEmpty(tag))
                       .ToList();
    }

    private string GetMoodCategoryClass(MoodCategory category)
    {
        return category switch
        {
            MoodCategory.Positive => "mood-positive",
            MoodCategory.Neutral => "mood-neutral", 
            MoodCategory.Negative => "mood-negative",
            _ => ""
        };
    }
}